name: Deploy static content to Pages. Changes in css and js versions to perform cache busting

# workflow_dispatch acts like when: manual in gitlab
on:
  push:
    branches: ["dev"]
  workflow_dispatch:

# controls what the workflowâ€™s built-in GITHUB_TOKEN is allowed to do while the job runs.
permissions:
  # Lets the workflow read your repository files (so actions/checkout can fetch code). It does not allow pushing commits.
  contents: read
  # Lets the workflow upload the Pages artifact and trigger a Pages deployment (used by actions/upload-pages-artifact and actions/deploy-pages).
  pages: write
  # Allows the workflow to request an OIDC ID token. GitHub uses this for the secure deployment handshake to Pages (the deploy action relies on it).
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'deploy')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      # Build a deploy folder and rewrite asset URLs there (no commits)
      - name: Prepare dist + cache-bust assets
        shell: bash
        run: |
          set -euo pipefail

          # unique version per deploy (short SHA + run number)
          VERSION="${GITHUB_SHA:0:8}-${GITHUB_RUN_NUMBER}"
          echo "Using version: $VERSION"

          # copy site into dist (exclude git + workflow files)
          rm -rf dist
          mkdir -p dist
          rsync -av \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "dist" \
            ./ dist/

          # rewrite ALL html files in dist to add/update ?v= on CSS/JS
          python3 - <<'PY'
          import re
          from pathlib import Path
          import os

          version = os.environ.get("VERSION")
          if not version:
            raise SystemExit("VERSION env missing")

          dist = Path("dist")
          html_files = list(dist.rglob("*.html"))

          # Replace style.css or style.css?v=... with style.css?v=VERSION
          css_pat = re.compile(r'(href="[^"]*style\.css)(?:\?v=[^"]*)?(")', re.IGNORECASE)

          # Replace script.js or script.js?v=... with script.js?v=VERSION
          js_pat  = re.compile(r'(src="[^"]*script\.js)(?:\?v=[^"]*)?(")', re.IGNORECASE)

          for f in html_files:
            s = f.read_text(encoding="utf-8")
            s2 = css_pat.sub(rf'\1?v={version}\2', s)
            s2 = js_pat.sub(rf'\1?v={version}\2', s2)
            f.write_text(s2, encoding="utf-8")

          print(f"Updated {len(html_files)} HTML files with v={version}")
          PY
        env:
          VERSION: ${{ github.sha }}-${{ github.run_number }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "dist"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
